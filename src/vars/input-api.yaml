# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# Description: This contains the test groups and test cases that 
# will be executed by the quality assurance playbook

# Map of functional type name and actual values
sap_functional_test_type_map:
  - name:                           "DatabaseHighAvailability"
    value:                          HA_DB
  - name:                           "CentralServicesHighAvailability"
    value:                          HA_SCS

test_groups:
  - name:                           HA_DB_HANA
    test_cases:
      - name:                       HA Parameters Validation
        task_name:                  ha-config
        description:                This validates the HA configuration

      # - name:                       HA Functional Test- Resource Migration
      #   task_name:                  resource-migration
      #   description:                This runs a functional test for resource migration

      # - name:                       HA Functional Test- Primary Node Crash
      #   task_name:                  primary-node-crash
      #   description:                This runs a functional test for primary node crash

      - name:                       HA Functional Test- Block Network Communication
        task_name:                  block-network
        description:                This runs a functional test for blocking network communication
      
      # - name:                       HA Functional Test- Crash index server on primary node
      #   task_name:                  crash-index
      #   description:                This runs a functional test for crashing index server on primary node

      # - name:                       HA Functional Test- Primary Node Kill
      #   task_name:                  primary-node-kill
      #   description:                This runs a functional test for primary node crash

      # - name:                       HA Functional Test- Echo B
      #   task_name:                  echo-b
      #   description:                This runs a functional test to immediately reboot the system without properly shutting it down.

  - name:                           HA_SCS
    test_cases:
      - name:                       HA Parameters Validation
        task_name:                  ha-config
        description:                This validates the HA configuration

# Commands for HANA DB HA Test Cases based on OS family
commands:
  - name:                           automated_register_cmd
    SUSE:                           "set -o pipefail; crm configure show | grep AUTOMATED_REGISTER=true | awk '{print $6}'"
    REDHAT:                         "set -o pipefail; pcs config show | grep AUTOMATED_REGISTER=true | awk '{print $1}'"

  - name:                           resource_migration_cmd
    SUSE:                           "crm resource move msl_SAPHana_{{ db_sid | upper }}_HDB{{ db_instance_number }} {{ cluster_status_pre.secondary_node | default('') }} force"
    REDHAT:                         "pcs resource move SAPHana_{{ db_sid | upper }}_{{ db_instance_number }}-clone --master"

  - name:                           crm_report_cmd
    SUSE:                           "crm_report -f '{{ test_group_start_time }}' /tmp/{{ test_group_invocation_id }}"
    REDHAT:                         "crm_report -f '{{ test_group_start_time }}' --dest /tmp/{{ test_group_invocation_id }} -yes"
