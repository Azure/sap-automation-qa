<!DOCTYPE html>
<html>
  <head>
    <title>SAP Automation QA Results</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        background-color: #f2f2f2; /* Microsoft's Light Gray */
      }
      
      .navbar {
        display: flex;
        justify-content: center; /* Centers the content horizontally */
        align-items: center;
        padding: 10px;
        background-color: #0078d7; /* Microsoft's Blue */
        color: #ffffff; /* White for contrast */
        transition: all 0.3s ease;
      }
      
      .main-content {
        flex: 1;
      }
      
      .navbar .system-id {
        font-weight: bold;
      }
      
      .container {
        display: flex;
        align-items: flex-start;
      }
      
      .left-bar {
        flex: 1; /* take up 1/3 of the space */
        padding: 20px;
      }
      
      .right-content {
        flex: 2; /* take up 2/3 of the space */
        padding: 20px;
      }
      
      .system-status {
        font-weight: bold;
        color: #323130; /* Microsoft's Dark Gray */
      }
      
      .system-info {
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.1);
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: start;
      }
      
      .system-info h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 24px;
      }
      
      .system-info p {
        color: #666;
        margin-bottom: 10px;
      }
      
      .system-info p strong {
        color: #333;
        font-weight: 600;
      }
      
      .test-case {
        margin-bottom: 10px;
      }
      
      .test-case .title {
        cursor: pointer;
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
      }
      
      .test-case .title:hover {
        background-color: #dee2e6;
      }
      .test-case .title .name,
      .test-case .title .duration {
        display: inline-block;
      }
      
      .test-case .details {
        display: none;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      
      .cluster-table,
      .package-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }
      
      .details {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      
      .details th,
      .details td {
        padding: 8px;
        text-align: left;
        word-wrap: break-word;
        white-space: pre-wrap;
        vertical-align: top;
      }
      
      .details th {
        background-color: #f2f2f2;
        color: #333;
      }
      
      .details tr:nth-child(even) {
        background-color: #f2f2f2;
      }
      
      .details tr:hover {
        background-color: #ddd;
      }
      
      .test-case.failed .title {
        background-color: #df3d3d; /* Softer Red */
        color: white;
      }
      
      .test-case.passed .title {
        background-color: #2a882e; /* Softer Green */
        color: white;
      }
      
      .test-case.warning .title {
        background-color: #fcd116; /* Softer yellow  */
        color: white;
      }
      
      .footer {
        bottom: 0;
        width: 100%;
        height: 40px; /* Set the fixed height of the footer here */
        padding: 10px;
        text-align: center;
        background-color: #0078d7; /* Microsoft's Blue */
        color: #ffffff; /* White for contrast */
        font-family: Arial, sans-serif;
      }
      
      @media only screen and (max-width: 600px) {
        .container {
          max-width: 100%;
          padding: 0 15px;
        }
      
        .navbar,
        .footer {
          flex-direction: column;
          text-align: center;
        }
      
        .test-case .title {
          flex-direction: column;
        }
      
        .test-case .title .name,
        .test-case .title .duration {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <div class="system-id">SAP Automation QA Results</div>
    </div>
    <div class="main-content">
      <div class="container">
        <div class="left-bar">
          <div class="system-info">
            <h2>System Information</h2>
            <p>
              <strong>Test Group Name:</strong> {{ test_case_results.0.TestGroupName }}
            </p>
            <p>
              <strong>DB SID:</strong> {{ test_case_results.0.DbSid }}
            </p>
            <p>
              <strong>SAP SID:</strong> {{ test_case_results.0.SapSid }}
            </p>
            <p>
              <strong>DB Fencing Agent:</strong> {{ test_case_results.0.DbFencingType }}
            </p>
            <p>
              <strong>SCS Fencing Agent:</strong> {{ test_case_results.0.ScsFencingType }}
            </p>
            <p>
              <strong>DB Type:</strong> {{ test_case_results.0.DBType }}
            </p>
            <p>
              <strong>OS Version:</strong> {{ test_case_results.0.OsVersion }}
            </p>
            <p>
              <strong>Hostnames:</strong>
              {{ test_case_results|map(attribute='TestCaseHostname')|unique|join(', ') }}
            </p>
          </div>
        </div>
        <div class="right-content">
          {% for test_case_result in test_case_results %}
            <div class="test-case {{ test_case_result.TestCaseStatus|lower }}">
              <div class="title" onclick="toggleDetails(this)">
                <span class="name">{{ test_case_result.TestCaseName }}</span>
                <span class="duration">&#x1F550; {{ test_case_result.DurationSeconds }}</span>
              </div>
              <table class="details">
                <tr>
                  <th>Test Description</th>
                  <td>{{ test_case_result.TestCaseDescription }}</td>
                </tr>
                <tr>
                  <th>Invocation ID</th>
                  <td>{{ test_case_result.TestCaseInvocationId }}</td>
                </tr>
                <tr>
                  <th>Start Time</th>
                  <td>{{ test_case_result.TestCaseStartTime }}</td>
                </tr>
                <tr>
                  <th>End Time</th>
                  <td>{{ test_case_result.TestCaseEndTime }}</td>
                </tr>
                {% if test_case_result.TestExecutionStartTime %}
                  <tr>
                    <th>Test Execution Start Time</th>
                    <td>{{ test_case_result.TestExecutionStartTime }}</td>
                  </tr>
                {% endif %}
                {% if test_case_result.TestExecutionEndTime %}
                  <tr>
                    <th>Test Execution End Time</th>
                    <td>{{ test_case_result.TestExecutionEndTime }}</td>
                  </tr>
                {% endif %}
                <tr>
                  <th>Message</th>
                  <td>{{ test_case_result.TestCaseMessage }}</td>
                </tr>
                <tr>
                  <th>Package Versions</th>
                  <td class="packages">{{ test_case_result.PackageVersions }}</td>
                </tr>
                <tr>
                  <th>Test Case Details (Logs)</th>
                  {% if 'HA Parameters Validation' in test_case_result.TestCaseName %}
                    <td class="cluster">{{ test_case_result.TestCaseDetails }}</td>
                  {% else %}
                    <td class="jsonobject">{{ test_case_result.TestCaseDetails }}</td>
                  {% endif %}
                </tr>
                {% if test_case_result.TestCaseLogMessagesFromSap %}
                  <tr>
                    <th>Logs from /var/log/messages</th>
                    <td class="newlinemessages">
                      <details>
                        <summary>Click to expand</summary>
                        {{ test_case_result.TestCaseLogMessagesFromSap }}
                      </details>
                    </td>
                  </tr>
                {% endif %}
              </table>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="footer">Report generated on: {{ report_generation_time }}</div>
    <script>
      // Function to beautify JSON objects
      const jsonObjects = document.getElementsByClassName('jsonobject')
      for (let jsonObjectElement of jsonObjects) {
        try {
          const jsonString = jsonObjectElement.textContent.trim()
          const fixedJsonString = jsonString
            .replace(/False/g, 'false')
            .replace(/True/g, 'true')
            .replace(/\\n/g, '')
            .replace(/None/g, 'null')
            .replace(/'([^']+)'(?=\s*:)/g, '"$1"')
            .replace(/:\s*'([^']*)'(?=\s*[,\}])/g, function (match, value) {
              if (value === '') {
                return ': ""'
              }
              return `: "${value}"`
            })
            .replace(/'([^']*)'(?=\s*[\],])/g, function (match, value) {
              if (value === '') {
                return '""'
              }
              return `"${value}"`
            })
      
          const jsonObject = JSON.parse(fixedJsonString)
          const beautifiedJson = JSON.stringify(jsonObject, null, 4)
          jsonObjectElement.textContent = beautifiedJson
        } catch (error) {
          console.error('Error parsing JSON:', error)
        }
      }
      
      const messages = document.getElementsByClassName('newlinemessages')
      for (let message of messages) {
        try {
          message.innerHTML = JSON.parse(message.textContent.trim().replace(/\\n/g, '').replace(/'/g, '"')).join('<br>')
        } catch (error) {
          console.error('Error formatting messages:', error)
        }
      }
      
      // Function to toggle the details of a test case
      function toggleDetails(element) {
        var details = element.nextElementSibling
        details.style.display = details.style.display === 'none' ? 'block' : 'none'
      }
      
      // Function to create a table for package versions
      function createPackageTable(packageList) {
        const containerText = packageList.replace(/'/g, '"')
      
        if (!containerText) return
      
        let packages
        try {
          packages = JSON.parse(containerText)
        } catch (e) {
          console.error('Failed to parse JSON:', e)
          return
        }
      
        const table = document.createElement('table')
        table.className = 'package-table'
        const thead = document.createElement('thead')
        const tbody = document.createElement('tbody')
      
        // Create table headers
        const headers = ['Package Name', 'Version', 'Release', 'Architecture']
        const headerRow = document.createElement('tr')
        headers.forEach((header) => {
          const th = document.createElement('th')
          th.textContent = header
          headerRow.appendChild(th)
        })
        thead.appendChild(headerRow)
      
        // Create table rows
        packages.forEach((pkg) => {
          const [packageName, details] = Object.entries(pkg)[0]
          const row = document.createElement('tr')
      
          const packageNameCell = document.createElement('td')
          packageNameCell.textContent = packageName
          row.appendChild(packageNameCell)
      
          const versionCell = document.createElement('td')
          versionCell.textContent = details.version
          row.appendChild(versionCell)
      
          const releaseCell = document.createElement('td')
          releaseCell.textContent = details.release
          row.appendChild(releaseCell)
      
          const archCell = document.createElement('td')
          archCell.textContent = details.architecture
          row.appendChild(archCell)
      
          tbody.appendChild(row)
        })
      
        table.appendChild(thead)
        table.appendChild(tbody)
        return table
      }
      
      // Call the function to create the table for package version
      const packageLists = document.getElementsByClassName('packages')
      for (let packageList of packageLists) {
        try {
          table = createPackageTable(packageList.textContent)
          const packagesContainer = packageList
          packagesContainer.textContent = '' // Clear the existing content
          packagesContainer.appendChild(table)
        } catch (error) {
          console.error('Error creating package table:', error)
        }
      }
      
      function createClusterTable(clusterData) {
        const table = document.createElement('table')
        table.className = 'cluster-table'
      
        function addRow(key, value, depth = 0) {
          const row = table.insertRow()
          const keyCell = row.insertCell()
          const valueCell = row.insertCell()
          keyCell.style.paddingLeft = depth * 10 + 'px'
      
          if (Array.isArray(value)) {
            keyCell.textContent = key
            keyCell.style.fontWeight = 'bold'
            value.forEach((item) => {
              const [subKey, subValue] = item.split(': ')
              addRow(subKey, subValue, depth + 1)
            })
          } else if (typeof value === 'object' && value !== null) {
            keyCell.textContent = key
            keyCell.style.fontWeight = 'bold'
            for (const [subKey, subValue] of Object.entries(value)) {
              addRow(subKey, subValue, depth + 1)
            }
          } else {
            keyCell.textContent = key
            valueCell.textContent = value
          }
        }
      
        for (const [key, value] of Object.entries(clusterData)) {
          addRow(key, value)
        }
      
        return table
      }
      
      // Function to parse and convert cluster data to tables
      function parseClusterData() {
        const clusterElements = document.getElementsByClassName('cluster')
        for (let clusterElement of clusterElements) {
          try {
            const clusterText = clusterElement.textContent.trim()
            const fixedClusterText = clusterText.replace(/'/g, '"').replace(/False/g, 'false').replace(/True/g, 'true')
            const clusterData = JSON.parse(fixedClusterText)
            const clusterTable = createClusterTable(clusterData)
      
            clusterElement.textContent = '' // Clear the existing content
            clusterElement.appendChild(clusterTable)
          } catch (error) {
            console.error('Error parsing cluster data:', error)
          }
        }
      }
      
      // Call the function to parse and convert cluster data
      parseClusterData()
    </script>
  </body>
</html>
